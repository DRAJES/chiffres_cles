---
title: "Licences sportives"
output: 
  flexdashboard::flex_dashboard:
    vertical_layout: scroll
    social: menu
    #source_code: embed
    navbar:
      - { title: "Accueil", href: index.html, align: right, icon: fa-home }
    theme: simplex
---

```{r, include=FALSE ,echo=FALSE, cache=F}

load("data/sport/spark.RData")
load("data/sport/licences.RData")

regsexe <- lic_reg_sexe %>% 
  select(-1) %>%
  slice(16,17) %>%
  pivot_longer(-1, names_to = "REG", values_to = "licences") %>%
  pivot_wider(REG,names_from = "fede",values_from = "licences") %>%
  mutate(txfem=round(100*`Licences féminines`/Total,1) )

  

fede_sexe_dep[c(38,89,113),1] <- "Total"


pallic <- colorBin("RdYlBu", domain =0:100 , reverse = TRUE,
                   bins= c(0, 15, 20, 25, 30, 100) )

carto <- function(.map,var=NULL) {

  .map %>%
    addPolygons(color = "#2F4F4F", weight=2, opacity = 0.6,
                fill=F, smoothFactor = 2 ) %>%
    addCircles(data = carte,
               centroid(carte)[,1],centroid(carte)[,2],
               group = "region", 
               radius= ~ 50 * `Nombre de licences`^(1/2),
               fillColor = ~ pallic (`Taux de licences`), fillOpacity = 0.8,
               color = "#4169E1", weight=4,  opacity = 0.8,
               highlight = highlightOptions (
                 color = "#00FFFF", weight = 5,
                 fillOpacity =  0.1),
               popup = popupTable(carte@data %>%
                                    relocate(Libellé,.before = Population) %>%
                                    select(-1,-var),
                                  feature.id=F,row.numbers = F)) %>%
    addLegend( pal = pallic , values = carte$`Taux de licences`,
               position = "bottomright", 
               title = "taux de pénétration sportive" ) }
```

![](images/BFC_s.svg) Régions {data-orientation="rows" height=30}
=======================================================================
Row {data-height="20"}
-----------------------------------------------------------------------
Row {data-height="120"}
-----------------------------------------------------------------------

### Données générales

La région Bourgogne-Franche-Comté compte **`r prettyNum(round(as.numeric(lic_reg[117,5])/1000,0)*1000,big.mark = " ")`** licenciés en 2020.
La pratique sportive est moins développée qu'au niveau national : le taux de pénétration sportive atteint **21,9 %** contre 22,7 % en France métropolitaine.
Mais la pratique féminine est plus fréquente : **39,7 %** des licences sont détenues par des femmes contre 38,8 % en France.  
Le football est la discipline la plus pratiquée et parmi les moins mixte : seulement 10 % des licences de football sont détenues par des femmes.
à l'inverse certaines fédérations sont très féminisées comme la gymnastique, l'équitation ou encore la danse.

Row {.tabset .tabset-fade .tabset-pills data-height="600"}
-----------------------------------------------------------------------

### Comparaisons

**11e** région de France en nombre de licenciés. **9e** région en licences par habitant (**0,8 points** de moins que la moyenne nationale)

```{r}
licreg <- lic_reg %>% 
  select(-2,-16) %>%
  slice(114) %>%
  pivot_longer(-1, names_to = "REG", values_to = "licences") %>%
  select(-1) %>%
  left_join(.,pop_basecom(REG)
            ,by="REG" )    %>%
  adorn_totals("row",name = "FM",fill = "France métro") %>%
  mutate(txlic=round(100*licences/pop,1))

hw_grid(
hchart(licreg %>% slice(-14) %>% 
         arrange(desc(licences)),
"bar", hcaes(x=reorder(Libellé,licences),y=licences,
            color=ifelse(REG=="27","#6a5acd","#ffd700") ),
       showInLegend = F, pointWidth = 20,
       name = "Licences") %>%
    hc_xAxis(title=list(text="Région")) %>%
    hc_yAxis(title=list(text="Nombre de licences")) %>%
    hc_add_theme(thm) %>%
    hc_exporting(enabled = TRUE, filename = "custom-file-name"),

hchart(licreg %>% 
         arrange(desc(txlic)),
 "bar",hcaes(x=reorder(Libellé,txlic),y=txlic,
             color=ifelse(REG=="27","#6a5acd",
                   ifelse(REG=="FM","#ff7f50","#ffd700") ) ) , 
       showInLegend = F, pointWidth = 10,
       name = "Taux de licences" ) %>%
    hc_xAxis(title=list(text="Région")) %>%
    hc_yAxis(title=list(text="Taux de licences (%)")) %>%
    hc_add_theme(thm) %>%
    hc_exporting(enabled = TRUE, filename = "custom-file-name"),

rowheight = 550)

```

### Licences par fédérations

Environ **40 % ** de licences féminines. 

```{r}
tab <- 
  lic_reg %>% 
  select(-1) %>%
  filter(str_detect(fede,"Total")) %>%
  pivot_longer(-fede,names_to = "REG",values_to = "clubs") %>%
  pivot_wider(names_from = fede, values_from = clubs) %>%
  libelle(geo=REG) %>%
  rename(`unisports olympiques`="Total fédérations unisport olympiques",
         `unisports non olympiques`="Total fédérations unisport non olympiques",
         multisports=`Total fédérations multisports`,
         `Total licences`=`Total général (hors groupements nationaux)` ) %>%
  
  left_join(.,licreg %>%
              select(REG,`Taux de licences (%)`=txlic), 
            by="REG") %>%
  
  left_join(., regsexe %>%
              select(REG, txfem), #tx femmes
            by="REG") %>% 
  
  mutate (`Licences féminines (%)`=color_bar('pink')
                      (digits(txfem,1,decimal.mark=",")))   %>%  
  select(-txfem) %>%


  left_join( evoreg %>%
               filter(type=="total")  %>% # sparkline modifier pour les différents types de fédé
               summarise(`évolution 2010-2021`=spk_chr(lic)) ) 

tab[14,2] <- "France métro"
tab %>%
  cc_kable("rcrrrrrlrr") %>%
  column_spec(6, bold=T) %>%
  add_header_above(c( " "=2,"Fédérations"=3,"Licences"=4) ) %>%
  credits()


```

### Répartition 
Plus de la **moitié** des licences dans les fédérations unisport olympiques.

```{r}
tab <- 
  tab %>% 
  select(2:5) %>%
  pivot_longer(-1,names_to = "type_fede",values_to = "licences")

hw_grid(
  tab %>% 
    filter(type_fede != "Total licences" &
             Libellé != "France métro") %>%
    hchart("bar",
           hcaes(x = Libellé, y = licences, group = type_fede) ,
           stacking = "normal" ,
           showInLegend = T,  pointWidth =20) %>%
    hc_yAxis(title=list(text="Nombre de licences")) %>%
    hc_add_theme(thm) %>%
    hc_exporting(enabled = TRUE, filename = "custom-file-name"),
  
  tab %>%
    filter(type_fede != "Total licences") %>%
    hchart("bar",
           hcaes(x = Libellé, y = licences, group = type_fede) ,
           stacking = "percent" ,
           showInLegend = T,  pointWidth =20) %>%
    hc_yAxis(title=list(text="% des licences")) %>%
    hc_add_theme(thm) %>%
    hc_exporting(enabled = TRUE, filename = "custom-file-name"),

rowheight = 550)

```

### Carte

```{r}
carte <- regwgs
carte@data <- carte@data %>% select(Région=REG)
carte <- merge(carte,licreg %>%
                 select(Région=REG,Libellé,Population=pop,
                        `Nombre de licences`=licences,
                        `Taux de licences`=txlic),
               by="Région")


leaflet(regwgs) %>% 
  carto() %>%
  contour_bfc() 

```

Row {.tabset .tabset-fade .tabset-pills data-height="600"}
-----------------------------------------------------------------------

### Détail unisport olympique

Le football représente près du **quart** des licences unisport olympiques. Celles-ci baissent pour la première fois en 2020.

```{r}
tab <- 
  lic_reg %>%  
  filter(!is.na(code_fede)) %>%
  mutate(type_fede = 
           case_when(code_fede > '100' & code_fede < '200' ~ "unisport olympique",
                     code_fede > '200' & code_fede < '300' ~ "unisport non olympique",
                     code_fede > '400' & code_fede < '700' ~ "multisport",
                     TRUE ~ "autres") ) %>%
  left_join(.,fedsexe %>%
              select (code_fede=1,licf=4,lict=6) ,
            by ="code_fede") %>%
  left_join( evofede %>%
               summarise(`évolution 2010-2021`=spk_chr(lic)),
             by=c("code_fede"="fed") ) %>%
  arrange(desc(FM)) %>%
  rename("France métro"=FM, "Code fédération" = code_fede, "Fédération"=fede) 





tab %>%
  filter(type_fede == "unisport olympique") %>%
  select(-type_fede) %>%  
  adorn_totals("row",name = "Total",
               fill = "Total fédérations unisports olympiques") %>% 
  mutate(`Licences féminines (%)`=color_bar('pink')
         (digits(100*licf/lict,1,decimal.mark=","))) %>%
  select(-licf,-lict) %>% 
  relocate(`Licences féminines (%)`,.before = `évolution 2010-2021`) %>%
  mutate(`évolution 2010-2021`=replace(`évolution 2010-2021`,`Code fédération`=="Total",
                                       evofede %>% 
                                         filter(fed<200) %>% 
                                         group_by(année) %>%
                                         summarise(fed="total",lic=sum(lic,na.rm=T)) %>%
                                         summarise(`évolution 2010-2021`=spk_chr(lic))
                                       ) ) %>%

  cc_kable("clrrrrrrrrrrrrrrl") %>%
  add_header_above(c(" "=2,"Code région"=13," "=3) )%>%
  column_spec(5, bold=T, background = "#E0FFFF75",  color = "steelblue") %>%
  column_spec(16, bold=T) %>%
  credits() %>%
  footnote(number = c("F= Fédération \n","FF = Fédération Française") )

```

### Détail unisport non olympique

**1/5e** des  licences unisport non olympique en pétanque, <b>1/6e</b> en randonnée

```{r}
tab %>%
  filter(type_fede == "unisport non olympique") %>%
  select(-type_fede) %>%  
  adorn_totals("row",name = "Total",
               fill = "Total fédérations unisports non olympiques") %>% 
  mutate(`Licences féminines (%)`=color_bar('pink')
         (digits(100*licf/lict,1,decimal.mark=","))) %>%
  select(-licf,-lict) %>% 
  relocate(`Licences féminines (%)`,.before = `évolution 2010-2021`) %>%
  mutate(`évolution 2010-2021`=replace(`évolution 2010-2021`,`Code fédération`=="Total",
                                       evofede %>% 
                                         filter(fed>200 & fed<400) %>% 
                                         group_by(année) %>%
                                         summarise(fed="total",lic=sum(lic,na.rm=T)) %>%
                                         summarise(`évolution 2010-2021`=spk_chr(lic))
                                       ) ) %>%

  cc_kable("clrrrrrrrrrrrrrrl") %>%
  add_header_above(c(" "=2,"Code région"=13," "=3) )%>%
  column_spec(5, bold=T, background = "#E0FFFF75",  color = "steelblue") %>%
  column_spec(16, bold=T) %>%
  credits() %>%
  footnote(number = c("F= Fédération \n","FF = Fédération Française") )

```

### Détail multisport
Près d'un **quart** des licences multisport en UNSS
```{r}
tab %>%
  filter(type_fede == "multisport") %>%
  select(-type_fede) %>%  
  adorn_totals("row",name = "Total",
               fill = "Total fédérations multisports") %>% 
  mutate(`Licences féminines (%)`=color_bar('pink')
         (digits(100*licf/lict,1,decimal.mark=","))) %>%
  select(-licf,-lict) %>% 
  relocate(`Licences féminines (%)`,.before = `évolution 2010-2021`) %>%
  mutate(`évolution 2010-2021`=replace(`évolution 2010-2021`,`Code fédération`=="Total",
                                       evofede %>% 
                                         filter(fed>400) %>% 
                                         group_by(année) %>%
                                         summarise(fed="total",lic=sum(lic,na.rm=T)) %>%
                                         summarise(`évolution 2010-2021`=spk_chr(lic))
                                       ) ) %>%

  cc_kable("clrrrrrrrrrrrrrrl") %>%
  add_header_above(c(" "=2,"Code région"=13," "=3) )%>%
  column_spec(5, bold=T, background = "#E0FFFF75",  color = "steelblue") %>%
  column_spec(16, bold=T) %>%
  credits() %>%
  footnote(number = c("F= Fédération \n","FF = Fédération Française") )

```


### Poids des fédérations

```{r}
hw_grid(
  
  tab  %>% 
    filter(type_fede != "autres") %>%
    select(codefed=1,fede=2,bfc="27",type_fede) %>% 
    mutate(txBFC=round(100*bfc/sum(bfc,na.rm=T),1) ) %>% 
    arrange(desc(txBFC))  %>%
    
    data_to_hierarchical(c(type_fede,fede),txBFC) %>%
    
    hchart(type="treemap",
           allowDrillToNode = TRUE
           ) %>%
    hc_subtitle(text="<b>Bourgogne-Franche-Comté</b>") %>%
    hc_add_theme(thm) %>%
    hc_exporting(enabled = TRUE, filename = "custom-file-name"),
  
   tab  %>% 
    filter(type_fede != "autres") %>%
    select(codefed=1,fede=2,France="France métro",type_fede) %>% 
    mutate(txFrance=round(100*France/sum(France,na.rm=T) ,1) ) %>% 
    arrange(desc(txFrance))  %>%
    
    data_to_hierarchical(c(type_fede,fede),txFrance) %>%
    
    hchart(type="treemap",
           allowDrillToNode = TRUE
           # levels = list( list
           #                (level = 1,
           #                  borderWidth = 0,
           #                  borderColor = "transparent",
           #                  dataLabels = list(enabled = TRUE) ),
           #                list(level = 2,
           #                  borderWidth = 0,
           #                  borderColor = "transparent",
           #                  dataLabels = list(enabled = TRUE) )
           #            ) 
           ) %>%
    hc_subtitle(text="<b>France métropolitaine</b>") %>%
    hc_add_theme(thm) %>%
    hc_exporting(enabled = TRUE, filename = "custom-file-name"),

  ncol = 2, rowheight=550)
```


### Sports les plus sexués

**Fédérations les plus sexuées : plus de 80% de licences masculines ou féminines**

```{r}
fede_sexe_dep %>% 
  filter(DEP=="BFC")%>%
  filter(txfem < 20 | txfem > 80 ) %>%
  arrange(desc(txfem)) %>%
  left_join(lic_dep %>% 
              select(fede=1,"Fédération"=2),
            by="fede") %>%
  hchart("bar", 
         hcaes(x=reorder(`Fédération`,txfem), y=txfem,
               color=ifelse(txfem > 80,"#ee82ee","#b0e0e6") ), 
         showInLegend = T, pointWidth = 5,
         name = "Taux de licences féminines BFC" ) %>%
  hc_add_series(tab %>% 
                  mutate(txfem=round(100*licf/lict),1) %>%
                  filter(txfem < 20 | txfem > 80 ) %>%
                  arrange(desc(txfem)) ,
                "bar", 
                hcaes(x=reorder(`Fédération`,txfem),y=txfem,
                      color=ifelse(txfem > 80, "#ba55d380", "#6495ed80") ), 
                showInLegend = T, pointWidth = 2,
                name = "Taux de licences féminines France" ) %>%
    hc_legend(title=list(text="Clic pour voir France ou BFC" )) %>%
    hc_xAxis(title=list(text="Fédérations taux de femmes <b> < ou > 80 % </b>")) %>%
    hc_yAxis(title=list(text="% de femmes (année 2021)")) %>%
    hc_add_theme(thm) %>%
    hc_exporting(enabled = TRUE, filename = "custom-file-name")
```


![](images/BFC_dep_s.svg) Départements {data-orientation="rows" height=30}
=======================================================================
Row {data-height="20"}
-----------------------------------------------------------------------

Row {data-height="100"}
-----------------------------------------------------------------------

### Données générales

La pratique sportive est diverse en Bourgogne-Franche-Comté. Le Jura est le département où la pratique licenciées est la plus développée avec **`r prettyNum(round(as.numeric(lic_reg[117,5])/1000,0)*1000,big.mark = " ")`** licenciés en 2020, en partie par l'importance de site de sport de nature dont les massifs montagneux. à l'inverse, l'Yonne est un des départements français où la pratique sportive est la plus faible. Cela ne signifie pas que les habitants ne pratiquent pas (cyclisme, randonnée...) mais ils sont moins souvent dans une structure.

 Row {.tabset .tabset-fade .tabset-pills data-height="600"}
-----------------------------------------------------------------------

### Comparaisons
**Le Jura et le Doubs au dessus de la moyenne nationale, les autres département de BFC en dessous.**

```{r}
licdep <- as.data.frame(t(lic_dep[118,4:99]))
licdep$departement <- t(as.data.frame(levels(lic_dep)[4:99]))

licdep <- licdep %>%
            rownames_to_column(var="dep") %>%
            mutate (dep=ifelse(nchar(dep)==1,paste0('0',dep),dep), 
                    V1=as.numeric(V1)) %>%
            left_join(.,depwgs@data %>% 
                        dplyr::select(dep=DEP,pop),
                      by="dep" ) %>%
            adorn_totals("row",name = "FR") %>%
            mutate(txlic=round(100*V1/pop,1)) 

licdep[97,3] <- "France"

hw_grid(
hchart(licdep %>% 
         slice(-97) %>% 
         arrange(desc(V1)),
"bar", hcaes(x=reorder(departement,V1),y=V1,
             color=ifelse(dep %in% depbfc,"#6a5acd","#ffd700") ),
      showInLegend = T, pointWidth = 1,
      name = "Licences" ) %>%
  hc_add_series(licdep %>% 
                  filter(dep %in% depbfc) %>% 
                  arrange(desc(V1)),
         "bar", hcaes(x=reorder(departement,V1),y=V1),
                color="#6a5acd", 
                showInLegend = F, pointWidth = 3,
                name = "Licences") %>%
  hc_legend(title=list(text=" France/BFC (Clic pour zoomer) " )) %>%
  hc_xAxis(title=list(text="Départements")) %>%
  hc_yAxis(title=list(text="Nombre de licences")) %>%
  hc_add_theme(thm) ,

hchart(licdep %>% 
         arrange(desc(txlic)),
"bar", hcaes(x=reorder(departement,txlic),y=txlic,
             color=ifelse(dep %in% depbfc,"#6a5acd",
                   ifelse(dep=="FR","#ff7f50","#ffd700")) ),
       showInLegend = T,  pointWidth =  1,
       name = "Taux de licences" ) %>%
  hc_add_series(licdep %>% 
                  filter(dep %in% depbfc | dep == "FR") %>%
                  arrange(desc(txlic)),
        "bar",  hcaes(x=reorder(departement,txlic),y=txlic,
                      color=ifelse(dep %in% depbfc,"#6a5acd","#ff7f50") ),
                showInLegend = F, pointWidth = 3, 
                name = "Taux de licences (%)") %>%
  hc_legend(title=list(text=" France/BFC (Clic pour zoomer) " )) %>%
  hc_xAxis(title=list(text="Départements")) %>%
  hc_yAxis(title=list(text="Taux de licences")) %>%
  hc_add_theme(thm),

rowheight = 550)
```


### Licences par fédération

**La pratique féminine plus développée dans le Jura.**

```{r}
lic_dep %>%  
  dplyr::select(2,depbfc) %>%
  slice(40,92,117,118) %>%
  pivot_longer(-`Codes départements`, 'variable', 'value') %>%
  pivot_wider(variable, names_from =`Codes départements`) %>%
  mutate(département=t(as.data.frame(levels(lic_dep) %>% 
                                       select(depbfc)))) %>%
  dplyr::select(6,2:5) %>% 
  dplyr::rename("Nombre"="NA") %>%
  mutate_at(2:5,as.numeric) %>% 
  adorn_totals("row") %>%
  bind_cols(licdep %>% 
              filter(dep %in% depbfc) %>%
              adorn_totals("row")  %>%
              mutate(txlic=round(100*V1/pop,1) ) %>% 
              select(txlic) %>% pull ) %>%
  #bind_rows(summarise_all(., ~if(is.numeric(.)) sum(.) else "Total"))    fonctionne également
  bind_cols( evodep %>%
               filter(type=="total")  %>% #modifier pour les différents types de fédé
               summarise(`évolution 2010-2021`=spk_chr(lic)) ) %>%
  left_join(.,feddepsexe %>% 
              select (1,txfem) %>% 
              slice(3:11) %>%                 #txfem
              mutate(`Licences féminines (%)`=color_bar('pink')
                    (digits(txfem,1,decimal.mark=","))) ,
            by=c("dep"="rowname") ) %>%
  relocate(dep, .before = département) %>% 
  relocate(`Licences féminines (%)`,.before = `évolution 2010-2021`) %>%
  rename(`unisport olympique`="Total fédérations unisport olympiques",
         `unisport non olympique`="Total fédérations unisport non olympiques", 
         multisports=`Total fédérations multisports`,
         `Taux de licences (%)`="...6") %>% 
  select(-10) %>%
  
  cc_kable("crrrrrrlr") %>%
  column_spec(6, 
              bold=T) %>%
  add_header_above(c( " "=2,"Fédérations"=3,"Licences"=4) ) %>%
  footnote(general = " MEDES recensement des licences sportives et des clubs 2021", 
           general_title = "Source : ",
           number = c("F= Fédération \n","FF = Fédération Française"), 
           footnote_as_chunk = T) %>%
   scroll_box(height = "550px") 

```

### Répartition
Plus de la moitié des licences dans les fédérations unisport olympiques.

```{r}
hw_grid(
hchart ( lic_dep %>%  
           dplyr::select(2,depbfc) %>%
           slice(40,92,117,118) %>%
           pivot_longer(-`Codes départements`, 'DEP') %>% 
           rename(type_fede=`Codes départements`,licences=value) %>%
           filter(!is.na(type_fede)) %>%
           left_join(.,appartenance %>% 
                       filter(NIVGEO=="DEP") %>%
                       select(CODGEO,département=LIBGEO),
                     by=c("DEP"="CODGEO") ) , 
  "bar", hcaes(x = fct_rev(département), 
               y= as.numeric(licences), 
               group = type_fede) ,
         stacking = "normal" ,
         showInLegend = T,  pointWidth =20) %>%
  hc_xAxis(title=list(text="Départements")) %>%
  hc_yAxis(title=list(text="Nombre de licences")) %>%
  hc_add_theme(thm),

hchart ( lic_dep %>%  
           dplyr::select(2,depbfc) %>%
           slice(40,92,117,118) %>%
           pivot_longer(-`Codes départements`, 'DEP') %>% 
           rename(type_fede=`Codes départements`,licences=value) %>%
           filter(!is.na(type_fede)) %>%
           left_join(.,appartenance %>% 
                       filter(NIVGEO=="DEP") %>%
                       select(CODGEO,département=LIBGEO),
                     by=c("DEP"="CODGEO") ) , 
  "bar", hcaes(x = fct_rev(département), 
               y= as.numeric(licences), 
               group = type_fede) ,
         stacking = "percent" ,
         showInLegend = T,  pointWidth =20) %>%
   hc_xAxis(title=list(text="Départements")) %>%
   hc_yAxis(title=list(text="Proportion de licences")) %>%
   hc_add_theme(thm),

rowheight = 550)


```

### Carte 

```{r}
sportdep <- as.data.frame(t(lic_dep)) %>%
                select(licences_tot=V118) %>%
                mutate(licences_tot=as.numeric(licences_tot)) %>%
                rownames_to_column("DEP") 

sportdep$DEP <- ifelse(nchar(sportdep$DEP)==1,
                             paste0("0",sportdep$DEP),
                             sportdep$DEP ) 

cartosportdep <- sp::merge(depwgs,sportdep,by="DEP")

leaflet(cartosportdep) %>% 
  addPolygons(color = "#2F4F4F",weight=2,opacity = 0.6, 
              fill=F, smoothFactor = 2 ) %>%
    contour_depbfc(zoom = 6) %>%
  addCircles(centroid(cartosportdep)[,1],centroid(cartosportdep)[,2],
             group = "region", radius=~50*licences_tot^(1/2),
             fillColor = ~pal2(100*cartosportdep$licences_tot/cartosportdep$pop),
             weight=4, color = "#4169E1", opacity = 0.8,
             fillOpacity = 0.8,
             highlight = highlightOptions (
                          color = "#00FFFF", weight = 5,  fillOpacity =  0.1 ),
             popup = popupTable(cartosportdep@data %>% 
                                  select(Département=LIBGEO,pop,licences_tot) %>%
                                  mutate(`Taux de licences`=100*licences_tot/pop),
                                feature.id=F,row.numbers = F)) %>%
addLegend( pal = pal2 , values = 100*(cartosportdep$licences_tot/cartosportdep$pop),
           position = "bottomright", title = "taux de pénétration sportive")

```





Row {.tabset .tabset-fade .tabset-pills data-height="600"}
-----------------------------------------------------------------------

### Détail unisport olympique

Une baisse des licences unisport olympiques en 2020.

```{r}
lic_dep %>%  
  dplyr::select(1:2,depbfc) %>% 
  rename("Code fédération"="...1","Fédération"="Codes départements") %>%
  slice(3:39) %>% 
  mutate_at(3:10,as.numeric) %>% 
  mutate(BFC=rowSums(.[3:10],na.rm = T)) %>% 
  arrange (desc(BFC)) %>% 
  adorn_totals("row") %>%
  left_join(.,fede_sexe_dep %>% 
              select (fede,DEP,txfem) %>% 
              filter (DEP=="BFC") %>%
              mutate(`Licences féminines (%)`=color_bar('pink',na.rm=T)
                    (digits(as.numeric(txfem),1,decimal.mark=","))) ,
            by=c("Code fédération"="fede") ) %>% 
  select(-txfem) %>%
  left_join( evofedebfc %>% 
               filter(fed>100 & fed<200) %>% #modifier pour type de fédé 
               bind_rows(evofedebfc %>% 
                           filter(fed>100 & fed<200) %>% 
                           group_by(année) %>%
                           summarise(fed="Total",lic=sum(lic,na.rm=T))) %>%
               summarise(`évolution 2010-2021`=spk_chr(lic)), 
             by=c("Code fédération"="fed")) %>%
  select(-12) %>%
  
  cc_kable("lcrrrrrrrrrlrl") %>% 
  kable_styling("hover", full_width = F) %>%
  column_spec(11, 
              bold=T) %>%
  footnote(general = " MEDES recensement des licences sportives et des clubs 2021", 
           general_title = "Source : ",
           number = c("F= Fédération \n","FF = Fédération Française"), 
           footnote_as_chunk = T) %>%
  scroll_box(height = "550px") 

```


### Détail unisport non olympique

```{r}
lic_dep %>%  
  dplyr::select(1:2,depbfc) %>% 
  rename("Code fédération"="...1","Fédération"="Codes départements") %>%
  slice(42:91) %>% 
  mutate_at(3:10,as.numeric) %>%
  mutate(BFC=rowSums(.[3:10],na.rm = T)) %>%  
  arrange (desc(BFC)) %>% 
  adorn_totals("row") %>%
  left_join(.,fede_sexe_dep %>% 
              select (fede,DEP,txfem) %>% 
              filter (DEP=="BFC") %>%
              mutate(`Licences féminines (%)`=color_bar('pink',na.rm=T)
                    (digits(as.numeric(txfem),1,decimal.mark=","))) ,
            by=c("Code fédération"="fede") ) %>%
  select(-txfem) %>%
  left_join( evofedebfc %>%   
               filter(fed>200 & fed<300) %>% #modifier pour type de fédé 
               bind_rows(evofedebfc %>% 
                           filter(fed>200 & fed<230) %>% 
                           group_by(année) %>%
                           summarise(fed="Total",lic=sum(lic,na.rm=T))) %>%
               summarise(`évolution 2010-2021`=spk_chr(lic)),
             by=c("Code fédération"="fed") ) %>% 
  select(-12) %>%
  
  cc_kable("lcrrrrrrrrrlrl") %>%
  column_spec(11, 
              bold=T) %>%
  footnote(general = " MEDES recensement des licences sportives et des clubs 2021", 
           general_title = "Source : ",
           number = c("F= Fédération \n","FF = Fédération Française"), 
           footnote_as_chunk = T) %>%
  scroll_box(height = "550px") 

```


### Détail des licences fédé multisport

```{r}
lic_dep %>%  
  dplyr::select(1:2,depbfc) %>% 
  rename("Code fédération"="...1","Fédération"="Codes départements") %>%
  slice(94:116) %>% 
  mutate_at(3:10,as.numeric) %>%
  mutate(BFC=rowSums(.[3:10],na.rm = T)) %>%  
  arrange (desc(BFC)) %>% 
  adorn_totals("row") %>%
  left_join(.,fede_sexe_dep %>% 
              select (fede,DEP,txfem) %>% 
              filter (DEP=="BFC") %>%
              mutate(`Licences féminines (%)`=color_bar('pink',na.rm=T)
                    (digits(as.numeric(txfem),1,decimal.mark=","))) ,
            by=c("Code fédération"="fede") ) %>% 
  select(-txfem) %>%
  left_join( evofedebfc %>%   
               filter(fed>400) %>% #modifier pour type de fédé 
               bind_rows(evofedebfc %>% 
                           filter(fed>400) %>% 
                           group_by(année) %>%
                           summarise(fed="Total",lic=sum(lic,na.rm=T))) %>%
               summarise(`évolution 2010-2021`=spk_chr(lic)),
             by=c("Code fédération"="fed") ) %>% 
  select(-12) %>%
  
  cc_kable("lcrrrrrrrrrlrl") %>%
  column_spec(11, 
              bold=T) %>%
  footnote(general = " MEDES recensement des licences sportives et des clubs 2021", 
           general_title = "Source : ",
           number = c("F= Fédération \n","FF = Fédération Française"), 
           footnote_as_chunk = T) %>%
  scroll_box(height = "550px") 

```


![](images/BFC_EPCI_s.svg) EPCI {data-orientation="rows" height=30}
=======================================================================
Row {data-height="20"}
-----------------------------------------------------------------------
Row {.tabset .tabset-fade }
-----------------------------------------------------------------------

### Comparaisons établissements publics de coopération intercommunale {vertical_layout=scroll}

```{r,echo=F}

lic27epci %>%
  select(EPCI,LIBGEO,licences,
         txlic,txlicf,txlich,txlicjeunes,txfemmes,txjeunes) %>% 
  arrange(desc(licences)) %>%
  mutate(txlic = color_bar('orange')
        (digits(txlic,1, decimal.mark=","))) %>%
  mutate(txlicf = color_bar('lightpink',na.rm=T)
        (digits(txlicf ,1,decimal.mark=","))) %>%
  mutate(txlich = color_bar('lightblue',na.rm=T)
        (digits(txlich ,1,decimal.mark=","))) %>% 
   mutate(txlicjeunes = color_bar('lightgreen',na.rm=T)
        (digits(txlicjeunes ,1,decimal.mark=","))) %>% 
  
  mutate(txfemmes = color_tile('white','pink',alpha=0.5)
         (digits(txfemmes,1,decimal.mark=","))) %>%
  mutate(txjeunes= color_tile('white','lightgreen',alpha=0.5)
         (digits(txjeunes,1,decimal.mark=","))) %>%

  rename(totales=txlic,femmes=txlicf,hommes=txlich,jeunes=txlicjeunes,
         féminines=txfemmes,`jeunes<20`=txjeunes) %>%
  
  cc_kable("lcrllllrrrrr") %>%
  add_header_above(c( " "=3,"Taux de licences parmi"=4,"Part de licences "=2) ) %>%
  footnote(general = " MEDES recensement des licences sportives et des clubs 2019", 
           general_title = "Source : ",
           number = c("F= Fédération \n","FF = Fédération Française"), 
           footnote_as_chunk = T) %>%
  scroll_box(height = "780px") 
```

### Carte ECPI {data-height="800"}

```{r}
 
lic_epci <- sp::merge(epciwgs,lic27epci %>%
                        select(EPCI, LIBGEO, licences, 
                               txlic, txfemmes, txlicf,txlich,txjeunes, txlicjeunes) %>%
                        mutate_at(3:8,as.numeric) ,
                      by="EPCI")

leaflet(lic_epci) %>%  
  addPolygons(color = "#2F4F4F", weight = 2,opacity = 0.6,
              fill = F ) %>%
    contour_depbfc() %>%
  addCircles(centroid(lic_epci)[,1],centroid(lic_epci)[,2],weight=4,
             radius = ~50*licences^(1/2),  color = "#4169E1",
             #radius = ~licences,
             fillColor = ~pal2(txlic), fillOpacity = 0.7,
             highlight = highlightOptions (
                            color = "#00FFFF",fillOpacity =  0.5, weight = 5 ),
             popup = popupTable(lic_epci@data %>% 
                                  select (-2,-3) %>%
                                  mutate(txlic = color_tile('white','orange',alpha = 0.5)
                                        (digits(txlic ,1,decimal.mark=","))) %>%
                                  mutate(txfemmes = color_tile('white','pink', alpha = 0.5)
                                        (digits(txfemmes ,1,decimal.mark=","))) %>%
                                  mutate(txlicf = color_tile('white','lightpink', alpha = 0.5)
                                        (digits(txlicf ,1,decimal.mark=","))) %>%
                                  mutate(txlich = color_tile('white', 'lightblue', alpha = 0.5)
                                        (digits(txlich ,1,decimal.mark=","))) %>%
                                  mutate(txjeunes= color_tile('white', 'lightgreen', alpha = 0.5)
                                        (digits(txjeunes,1,decimal.mark=","))) %>%
                                  mutate(txlicjeunes= color_tile('white', 'lightgreen', alpha=0.5)
                                        (digits(txlicjeunes,1,decimal.mark=","))),
                                feature.id=F,row.numbers = F) ) %>%
  addLegend( pal = pal2 ,values = ~txlic,
             position = "bottomright", title = "taux de pénétration sportive") 
#addLegendSize(position = "bottomright", values = 60000,color = "#4169E1",fillColor = "transparent",
#              strokeWidth =2, shape = "circle", breaks = 1, baseSize = 60, title = "taille initiale" )
```

![](images/BFC_BV_s.svg) Bassins de vie {data-orientation="rows" height=30}
=======================================================================
Row {data-height="20"}
-----------------------------------------------------------------------
 Row {.tabset .tabset-fade }
-----------------------------------------------------------------------

### Comparaisons bassins de vie {vertical_layout=scroll}

```{r,echo=F}
lic27bv %>%
  select(BV2012,LIBGEO,licences,
         txlic,txlicf,txlich,txlicjeunes,txfemmes,txjeunes) %>% 
  arrange(desc(licences)) %>%
  mutate(txlic = color_bar('orange')
        (digits(txlic,1, decimal.mark=","))) %>%
 
  mutate(txlicf = color_bar('lightpink',na.rm=T)
        (digits(txlicf ,1,decimal.mark=","))) %>%
  mutate(txlich = color_bar('lightblue',na.rm=T)
        (digits(txlich ,1,decimal.mark=","))) %>% 
   mutate(txlicjeunes = color_bar('lightgreen',na.rm=T)
        (digits(txlicjeunes ,1,decimal.mark=","))) %>% 
  
  mutate(txfemmes = color_tile('white','pink',alpha=0.5)
         (digits(txfemmes,1,decimal.mark=","))) %>%
  mutate(txjeunes= color_tile('white','lightgreen',alpha=0.5)
         (digits(txjeunes,1,decimal.mark=","))) %>%

  rename(totales=txlic,femmes=txlicf,hommes=txlich,jeunes=txlicjeunes,
         féminines=txfemmes,`jeunes<20`=txjeunes) %>%

  cc_kable("lcrllllrrrrr") %>%
  add_header_above(c( " "=3,"Taux de licences parmi"=4,"Part de licences "=2) ) %>%
  footnote(general = " MEDES recensement des licences sportives et des clubs 2019", 
           general_title = "Source : ",
           number = c("F= Fédération \n","FF = Fédération Française"), 
           footnote_as_chunk = T)   %>%
 scroll_box(height = "780px") 
```

### Carte BV {data-height="800"}

```{r}

lic_bv <- sp::merge(bvwgs,lic27bv %>%
                      select(BV2012,LIBGEO,licences,
                            txlic,txfemmes,txlicf,txlich,txjeunes,txlicjeunes) %>%
                      mutate_at(3:8,as.numeric) ,
                    by="BV2012")

leaflet(lic_bv) %>%  
  addPolygons( color = "#2F4F4F", weight = 2,opacity = 0.6,
               fill =F) %>%
    contour_depbfc() %>%
  addCircles(centroid(lic_bv)[,1],centroid(lic_bv)[,2],weight=4,
             radius = ~50*licences^(1/2), color = "#4169E1",
             fillColor = ~pal2(txlic), fillOpacity = 0.7,
             highlight = highlightOptions (
                         color = "#00FFFF", fillOpacity =  0.5, weight = 5 ),
             popup = popupTable(lic_bv@data %>% 
                                  mutate(txlic = color_tile('white','orange',alpha=0.5)
                                        (digits(txlic ,1,decimal.mark=","))) %>%
                                  mutate(txfemmes = color_tile('white','pink',alpha=0.5)
                                        (digits(txfemmes ,1,decimal.mark=","))) %>%
                                  mutate(txlicf = color_tile('white','lightpink',alpha=0.5)
                                        (digits(txlicf ,1,decimal.mark=","))) %>%
                                  mutate(txlich = color_tile('white', 'lightblue',alpha=0.5)
                                        (digits(txlich ,1,decimal.mark=","))) %>%
                                  mutate(txjeunes= color_tile('white','lightgreen',alpha=0.5)
                                        (digits(txjeunes,1,decimal.mark=","))) %>%
                                  mutate(txlicjeunes= color_tile('white','lightgreen',alpha=0.5)
                                        (digits(txlicjeunes,1,decimal.mark=","))) ,
                                feature.id=F,row.numbers = F) ) %>%
  addLegend( pal = pal2 ,values = ~txlic,
             position = "bottomright", title = "taux de pénétration sportive")

```


*En savoir* **+** {data-orientation="rows" data-icon="fa-info-circle" font-size="25px" }
=======================================================================
Row {data-height="20"}
-----------------------------------------------------------------------
Row {data-height="60"}
-----------------------------------------------------------------------

**Sources :**  



* Injep, MEDES, recensement des licences et des clubs sportifs

  + https://injep.fr/donnee/recensement-des-licences-sportives-2020/
  + https://carto-stats.injep.fr/#c=home  
   
* Insee, DRDJSCS, étude sur la pratique sportive  
Un habitant sur cinq réside dans un territoire où la pratique sportive est développée  

  + https://www.insee.fr/fr/statistiques/4984597


