---
title: "Clubs sportifs"
output: 
  flexdashboard::flex_dashboard:
    vertical_layout: scroll
    social: menu
    #source_code: embed
    navbar:
      - { title: "Accueil", href: index.html, align: right, icon: fa-home }
    theme: simplex

---

```{r, include=FALSE ,echo=FALSE, cache=F}
load("data/sport/licences.RData")
load("data/sport/clubs.RData")

#credits
credits <- function(.tbl){
  .tbl %>%
    footnote(general = " MEDES recensement des licences sportives et des clubs 2021", 
             general_title = "Source : ",
             footnote_as_chunk = T) %>%
    scroll_box(height = "550px") 
  
}



#recodage type fédé

type_fed <- function(.tbl) {
  .tbl %>% 
    filter(!is.na(code_fede)) %>%
    mutate(type_fede = 
           case_when(code_fede > '100' & code_fede < '200' ~ "unisports olympiques",
                     code_fede > '200' & code_fede < '300' ~ "unisports non olympiques",
                     code_fede > '400' & code_fede < '700' ~ "multisports",
                     TRUE ~ "autres") ) 
}

#détail des types de fédé
detail <- function(.tbl,type) {
  .tbl %>%
    filter(type_fede == type) %>%
    select(-type_fede) %>%  
    adorn_totals ("row",name = "Total",
                 fill = paste("Total fédérations",type) ) %>%
    mutate(`licences/clubs` = color_bar('lightgreen',na.rm=T)
           (digits(na_if(Licences/`Total`,Inf) ,1,decimal.mark=",")))  #correction de valeur infinie  
    }




#tableaux infra
tab_club <- function(.tbl,geo){

.tbl %>% 
  select({{geo}},LIBGEO,`Nombre de clubs`=total_clubs,
         `Nombre de licences` = licences, 
         txclub, txlic, liclub)  %>% 
  arrange(desc(`Nombre de clubs`)) %>%
  mutate(clubs = color_bar('gold',na.rm=T)
        (digits(txclub ,1,decimal.mark=","))) %>%
  mutate(licences = color_bar('orange',na.rm=T)
        (digits(txlic ,1,decimal.mark=","))) %>%
  mutate(`Licences par club` = color_bar('lightgreen',na.rm=T)
        (digits(liclub ,1,decimal.mark=","))) 
 }

#cartographie
pal <- colorBin("YlOrBr", domain =0:100 ,
                 bins= c(0, 15, 20, 25, 30,35, 100) )

# pallic <- colorBin(c("#d7191c","#fec981","#c4e687","#1a9641"), domain =0:100 ,
#                    bins= c(0, 19, 22, 25, 100) )
pallic <- colorBin("RdYlBu", domain =0:100 , reverse = TRUE,
                    bins= c(0, 19, 22, 25, 100) )

carto <- function(.map,var=NULL) {

  .map %>%
    addPolygons(color = "#2F4F4F", weight=2, opacity = 0.6,
                fill=F, smoothFactor = 2 ) %>%
    addCircles(data = carte,
               centroid(carte)[,1],centroid(carte)[,2],
               group = "region", 
               radius= ~ 500 * `Total clubs`^(1/2),
               fillColor = ~pal(10000*`Total clubs`/Population), fillOpacity = 0.8,
               color = "#4169E1", weight=4,  opacity = 0.8,
               highlight = highlightOptions (
                 color = "#00FFFF", weight = 5,
                 fillOpacity =  0.1),
               popup = popupTable(carte@data %>%
                                    relocate(Libellé,.before = Population) %>%
                                    select(-1,-var) %>% 
                                    mutate(`Taux de clubs`=round(10000*`Total clubs`/Population,1) ),
                                  feature.id=F,row.numbers = F)) %>%
    addLegend( pal = pal , values = carte$`Taux de clubs`,
               position = "bottomright", 
               title = "taux de clubs sportifs <br> pour 10 000 habitants" ) }


carto2 <- function(){
leaflet(carte) %>%  
  addPolygons( color = "#2F4F4F" , weight = 2,opacity = 0.6,
              fill = F ) %>%
    contour_depbfc() %>%
  addCircles(centroid(carte)[,1],centroid(carte)[,2],weight=4,
             radius = ~500*`Nombre de clubs`^(1/2), color = "#4169E1",
             fillColor = ~pallic(`Taux de licences`), fillOpacity = 0.7,
             highlight = highlightOptions (
                                  color = "#00FFFF", fillOpacity =  0.5, weight = 5 ),
             popup = popupTable(carte@data %>% 
                                  select (3,2,4,5,9:11) ,
                                feature.id=F,row.numbers = F) ) %>%
addLegend( pal = pallic ,values = ~`Taux de clubs`,
           position = "bottomright", title = "taux de pénétration sportive" )
}

```

![](images/BFC_s.svg) Régions {data-orientation="rows" height=30}
=======================================================================
Row {data-height="20"}
-----------------------------------------------------------------------
Row {data-height="100"}
-----------------------------------------------------------------------

### Données générales
La région Bourgogne-Franche-Comté compte **`r prettyNum(round(as.numeric(club_reg[118,5])/100,0)*100,big.mark = " ")`** clubs en 2021.
La moitié de ces clubs sont affiliés à une fédération unisport olympique. Parmi eux, **1 sur 6** sont des clubs de foot.

Row {.tabset .tabset-fade .tabset-pills data-height="600"}
-----------------------------------------------------------------------

### Comparaisons 

**11e** région de France en nombre de clubs, **6e** en clubs par habitant.

```{r}
clubreg <- club_reg %>% 
  select(-fede) %>%
  filter(code_fede == "TOTAL (hors groupements sportifs)") %>%
  pivot_longer(-1,names_to = "REG",values_to = "clubs") %>%
  left_join(.,pop_basecom(REG) %>%
              adorn_totals("row",name = "FM",fill="France métro"),
            by="REG" )  %>%
  mutate(txclub=round(10000*clubs/pop,1)) 


hw_grid(
  clubreg %>% 
    slice(-14) %>% 
    arrange(desc(clubs)) %>%
    hchart("bar", 
           hcaes(x=reorder(Libellé,clubs),y=clubs,
                 color=ifelse(REG=="27","#6a5acd","#ffd700") ), 
           showInLegend = F, pointWidth = 20,
           name = "Clubs" ) %>%
    hc_yAxis(title=list(text="Nombre de clubs")) %>%
    hc_add_theme(thm) %>%
    hc_exporting(enabled = TRUE, filename = "custom-file-name"),
  
  clubreg %>% 
    arrange(desc(txclub)) %>%
    hchart("bar",
           hcaes(x=reorder(Libellé,txclub),y=txclub,
                 color=ifelse(REG=="27","#6a5acd",
                              ifelse(REG=="FM","#ff7f50","#ffd700") ) ) , 
           showInLegend = F,  pointWidth = 10,
           name = "Taux de clubs") %>%
    hc_yAxis(title=list(text="Taux de clubs (/10 000 hab.)")) %>%
    hc_add_theme(thm) %>%
    hc_exporting(enabled = TRUE, filename = "custom-file-name"),
  
  rowheight = 550)
```

### Clubs par fédérations

**La moitié des clubs sont affiliés à une fédération unisport olympique.**

```{r}
tab <- 
  club_reg %>%
  select(-1) %>%
  filter(str_detect(fede,"Total")) %>%
  pivot_longer(-fede,names_to = "REG",values_to = "clubs") %>%
  pivot_wider(names_from = fede, values_from = clubs) %>%
  libelle(geo=REG) %>%
  rename(`unisports olympiques`="Total fédérations unisport olympiques",
         `unisports non olympiques`="Total fédérations unisport non olympiques",
         multisports=`Total fédérations multisports`,
         `Total clubs`=`Total (hors groupements sportifs)` ) %>%

  left_join(lic_reg %>%
              select(-1) %>%
              slice(114) %>%
              pivot_longer(-fede, 'variable', 'value') %>%
              pivot_wider(variable, names_from =  fede) %>%
              select(REG=1,licences=2),
            by="REG"   ) %>%  
  
  mutate(`licences par club` = color_bar('lightgreen')
         (digits(licences / `Total clubs` ,1,decimal.mark=","))) 

tab %>%  
  cc_kable(aligne = "rcrrrrrl") %>%
  column_spec(6, bold=T) %>%
  add_header_above(c( " "=2,"Fédérations"=3," "=3) ) %>%
  credits()

```

### Répartition 

```{r}
hw_grid(
  tab %>%  
    select(2:5) %>%
    pivot_longer(-1,names_to = "type_fede",values_to = "clubs") %>%
    filter(type_fede != "Total clubs" &
             Libellé != "France Métro") %>%
    hchart("bar",
           hcaes(x = Libellé, y = clubs, group = type_fede) ,
           stacking = "normal" ,
           showInLegend = T,  pointWidth =20) %>%
    hc_yAxis(title=list(text="Nombre de clubs")) %>%
    hc_add_theme(thm) %>%
    hc_exporting(enabled = TRUE, filename = "custom-file-name"),
  
  tab %>%
    select(2:5) %>%
    pivot_longer(-1,names_to = "type_fede",values_to = "clubs") %>%
    filter(type_fede != "Total clubs") %>%
    hchart("bar",
           hcaes(x = Libellé, y = clubs, group = type_fede) ,
           stacking = "percent" ,
           showInLegend = T,  pointWidth =20) %>%
    hc_yAxis(title=list(text="% des clubs")) %>%
    hc_add_theme(thm) %>%
    hc_exporting(enabled = TRUE, filename = "custom-file-name"),

rowheight = 550)

```

### Carte 

```{r}
carte <- regwgs
carte@data <- carte@data %>% select(Région=REG,Population=pop)
carte <- merge(carte,tab %>% rename(Région=REG),
               by="Région")


leaflet(regwgs) %>% 
  carto() %>%
  contour_bfc() 
```




Row {.tabset .tabset-fade .tabset-pills data-height="600"}
-----------------------------------------------------------------------

### Détail unisport olympique

**Des clubs de grande taille en football, handball, golf, gymnastique ou encore en natation.**

```{r}
tab <- 
  club_reg %>% 
  rename(Total=FM) %>%
  arrange(desc(`Total`)) %>%
  type_fed() %>%
  left_join(lic_reg %>% 
              dplyr::select(1,Licences="FM") ,
            by="code_fede" )  %>%
  rename("Code fédération" = code_fede, "Fédération"=fede) 



tab %>%
  detail(type = "unisports olympiques") %>%
  rename(`France métro`=Total) %>%
  cc_kable(aligne = "clrrrrrrrrrrrrrrrl") %>%
  add_header_above(c(" "=2,"Code région"=13," "=3) )%>%
  column_spec(5, bold=T, background = "#E0FFFF75",  color = "steelblue") %>%
  column_spec(16,bold=T) %>%
  credits() %>%
  footnote(number = c("F= Fédération \n","FF = Fédération Française") )
 

```

### Détail unisport non olympique

**Des clubs de plus petite taille pour les fédérations unisport non olympiques.**

```{r}
tab %>%
  detail(type = "unisports non olympiques") %>%
  rename(`France métro`=Total) %>%

  cc_kable(aligne = "clrrrrrrrrrrrrrrrl") %>%
  add_header_above(c(" "=2,"Code région"=13," "=3) )%>%
  column_spec(5, bold=T, background = "#E0FFFF75",  color = "steelblue") %>%
  column_spec(16, bold=T) %>%
  credits() %>%
   footnote(number = c("F= Fédération \n","FF = Fédération Française") )

```

### Détail multisport

**Une part importante du sport scolaire dans les fédérations multisports.**

```{r}
tab %>%
 detail(type = "multisports") %>%
 rename(`France métro`=Total) %>%
  
  cc_kable(aligne = "clrrrrrrrrrrrrrrrl") %>%
  add_header_above(c(" "=2,"Code région"=13," "=3) )%>%
  column_spec(5, 
              bold=T, background = "#E0FFFF75",  color = "steelblue") %>%
  column_spec(16, 
              bold=T) %>%
  credits() %>%
   footnote(number = c("F= Fédération \n","FF = Fédération Française") )

```

### Poids des fédérations 
```{r}
hw_grid(
  
  tab  %>% 
    filter(type_fede != "autres") %>%
    select(codefed=1,fede=2,bfc="27",type_fede) %>% 
    mutate(txBFC=round(100*bfc/sum(bfc,na.rm=T),1) ) %>% 
    arrange(desc(txBFC))  %>%
    
    data_to_hierarchical(c(type_fede,fede),txBFC) %>%
    
    hchart(type="treemap",
           allowDrillToNode = TRUE
    ) %>%
    hc_subtitle(text="<b>Bourgogne-Franche-Comté</b>") %>%
    hc_add_theme(thm) %>%
    hc_exporting(enabled = TRUE, filename = "custom-file-name"),
  
  tab  %>% 
    filter(type_fede != "autres") %>%
    select(codefed=1,fede=2,France="Total",type_fede) %>% 
    mutate(txFrance=round(100*France/sum(France,na.rm=T),1) ) %>% 
    arrange(desc(txFrance))  %>%
    
    data_to_hierarchical(c(type_fede,fede),txFrance) %>%
    
    hchart(type="treemap",
           allowDrillToNode = TRUE
    ) %>%
    hc_subtitle(text="<b>France métropolitaine</b>") %>%
    hc_add_theme(thm) %>%
    hc_exporting(enabled = TRUE, filename = "custom-file-name"),
  
rowheight = 550)
```



![](images/BFC_dep_s.svg) Départements {data-orientation="rows" height=30}
=======================================================================
Row {data-height="20"}
-----------------------------------------------------------------------

Row {data-height="100"}
-----------------------------------------------------------------------

### Données générales

La Nièvre et le Jura comptent plus de **10 clubs sportifs** pour 10 000 habitants. La Saône et Loire, 2 fois moins... En contre partie, la taille des clubs y est bien plus grande , comme dans le Territoire de Belfort, la Côte d'Or et le Doubs.

 Row {.tabset .tabset-fade .tabset-pills data-height="600"}
-----------------------------------------------------------------------

### Comparaisons 
**La Nièvre et le Jura fortement dotées en clubs par habitant.**

```{r}
clubdep <- club_dep %>% 
  select(-fede) %>%
  filter(code_fede == "TOTAL (hors groupements sportifs)") %>%
  pivot_longer(-1,names_to = "DEP",values_to = "clubs") %>%
  left_join(.,pop_basecom(DEP) %>%
              adorn_totals("row",name = "FM",fill="France métro"),
            by="DEP" )  %>%
  mutate(txclub=round(10000*clubs/pop,1)) 

hw_grid(
  clubdep %>% 
    slice(-97) %>% 
    arrange(desc(clubs)) %>%
    hchart( "bar",
            hcaes(x=reorder(Libellé,clubs),y=clubs,
                  color=ifelse(DEP %in% depbfc,"#6a5acd","#ffd700") ),
            showInLegend = T,  pointWidth = 1,
            name = "Nombre de clubs") %>%
    hc_add_series(clubdep %>% 
                    filter(DEP %in% depbfc) %>% 
                    arrange(desc(clubs)),
                  "bar", hcaes(x=reorder(Libellé,clubs),y=clubs) ,
                  color="#6a5acd" , 
                  showInLegend = F, pointWidth = 3,
                  name = "Nombre de clubs") %>%
    hc_legend(title=list(text=" France/BFC (Clic pour zoomer) " )) %>%
    hc_yAxis(title=list(text="Nombre de clubs sportifs")) %>%
    hc_add_theme(thm) %>%
    hc_exporting(enabled = TRUE, filename = "custom-file-name"),

clubdep %>% 
    arrange(desc(txclub)) %>%
    hchart( "bar",
            hcaes(x=reorder(Libellé,txclub),y=txclub,
                  color=ifelse(DEP %in% depbfc,"#6a5acd",
                               ifelse(DEP=="FM","#ff7f50","#ffd700") ) ) , 
            showInLegend = T,  pointWidth = 1,
            name = "Taux de clubs") %>%
    hc_add_series(clubdep %>% 
                    filter(DEP %in% depbfc) %>% 
                    arrange(desc(txclub)),
                  "bar", hcaes(x=reorder(Libellé,txclub),y=txclub) ,
                  color="#6a5acd" , 
                  showInLegend = F, pointWidth = 3,
                  name = "Taux de clubs") %>%
    hc_legend(title=list(text=" France/BFC (Clic pour zoomer) " )) %>%
    hc_yAxis(title=list(text="Taux de clubs (/10 000 hab.)")) %>%
    hc_add_theme(thm) %>%
    hc_exporting(enabled = TRUE, filename = "custom-file-name"),

rowheight = 550)

```

### Clubs par fédération

**Des clubs plus petits dans le Nièvre et dans l'Yonne.**

```{r}
tab <- 
  club_dep_bfc %>%
  select(-1,-12) %>%
  filter(str_detect(fede,"Total")) %>%
  pivot_longer(-fede,names_to = "DEP",values_to = "clubs") %>%
  pivot_wider(names_from = fede, values_from = clubs) %>%
  libelle(geo=DEP) %>%
  rename(`unisport olympique`="Total fédérations unisport olympiques",
         `unisport non olympique`="Total fédérations unisport non olympiques",
         multisports=`Total fédérations multisports`,
         `Total clubs`=`Total (hors groupements sportifs)` ) %>%
  left_join(lic_dep_bfc %>%
              select(-1) %>%
              slice(114) %>%
              pivot_longer(-`fede`, 'variable', 'value') %>%
              pivot_wider(variable, names_from =  `fede`) %>%
              select(DEP=1,licences=2),
            by="DEP"   ) %>%  
  
  mutate(`licences par club` = color_bar('lightgreen')
         (digits(licences / `Total clubs` ,1,decimal.mark=","))) 

tab %>%  
  cc_kable(aligne = "rcrrrrrl") %>%
  column_spec(6, bold=T) %>%
  add_header_above(c( " "=2,"Fédérations"=3," "=3) ) %>%
  credits()

```

### Répartition

```{r}
hw_grid(
  tab %>%   
    select(2:5) %>%
    pivot_longer(-Libellé,names_to = "type_fede",values_to = "clubs") %>%
    filter(type_fede != "Total clubs" &
             Libellé != "Bourgogne-Franche-Comté") %>%
    hchart("bar",
           hcaes(x = fct_rev(Libellé), y = clubs, group = type_fede) ,
           stacking = "normal" ,
           showInLegend = T,  pointWidth =20) %>%
    hc_yAxis(title=list(text="Nombre de clubs")) %>%
    hc_add_theme(thm) %>%
    hc_exporting(enabled = TRUE, filename = "custom-file-name"),
  
  tab %>%
    select(2:5) %>%
    pivot_longer(-Libellé,names_to = "type_fede",values_to = "clubs") %>%
    filter(type_fede != "Total clubs") %>%
    hchart("bar",
           hcaes(x = fct_rev(Libellé), y = clubs, group = type_fede) ,
           stacking = "percent" ,
           showInLegend = T,  pointWidth =20) %>%
    hc_yAxis(title=list(text="% des clubs")) %>%
    hc_add_theme(thm) %>%
    hc_exporting(enabled = TRUE, filename = "custom-file-name"),

rowheight = 550)
```

### Carte 

```{r}
carte <- depwgs
carte@data <- carte@data %>% select(Département=DEP)
carte <- merge(carte,clubdep %>%
                 select(Département=DEP,Libellé,Population=pop,
                        `Total clubs`=clubs,`Taux de clubs`=txclub),
               by="Département")
carte@data <- carte@data %>% left_join(tab %>% select(1,3:5,7:8),by=c("Département"="DEP")) 

leaflet(depwgs) %>% 
  carto() %>%
  contour_bfc() 

```



Row {.tabset .tabset-fade .tabset-pills data-height="600"}
-----------------------------------------------------------------------

### Détail unisport olympique

**Des clubs de football nombreux et de grande taille : près de 3x fois plus de licenciés par club qu'en équitation, 2x plus qu'au tennis. (Importance des sections jeunes ?)**

```{r}
tab <- 
  club_dep_bfc %>%  
  rename(Total=BFC) %>%
  select(-FM) %>%
  arrange(desc(`Total`)) %>%
  type_fede() %>%
  left_join(lic_dep_bfc %>% 
              dplyr::select(1,Licences="BFC"),
            by="code_fede" )  

tab %>%
  detail(type = "unisports olympiques") %>%
  rename(BFC=Total) %>%
 
  cc_kable(aligne = "lcrrrrrrrrrrl") %>%
  add_header_above(c(" "=2,"Codes départements"=8," "=3) )%>%
  column_spec(11, bold=T) %>%
  credits() %>%
   footnote(number = c("F= Fédération \n","FF = Fédération Française") )

```


### Détail unisport non olympique

**Les clubs de fédérations unisport non olympiques de très petite taille dans la région.**

```{r}
tab %>%
  detail(type = "unisports non olympiques") %>%
  rename(BFC=Total) %>%
  
  cc_kable(aligne = "lcrrrrrrrrrrl") %>%
  add_header_above(c(" "=2,"Codes départements"=8," "=3) )%>%
  column_spec(11, bold=T) %>%
  credits() %>%
   footnote(number = c("F= Fédération \n","FF = Fédération Française") )

```


### Détail multisport

```{r}
tab %>%
  detail(type = "multisports") %>%
  rename(BFC=Total) %>%
  
  cc_kable(aligne = "lcrrrrrrrrrrl") %>%
  add_header_above(c(" "=2,"Codes départements"=8," "=3) )%>%
  column_spec(11, bold=T) %>%
  credits() %>%
   footnote(number = c("F= Fédération \n","FF = Fédération Française") )

```


![](images/BFC_EPCI_s.svg) EPCI {data-orientation="rows" height=30}
=======================================================================
Row {data-height="20"}
-----------------------------------------------------------------------
Row {.tabset .tabset-fade }
-----------------------------------------------------------------------

### Comparaisons établissements publics de coopération intercommunale {vertical_layout=scroll}

```{r,echo=F}
tab <- 
  lic27epci %>%
  tab_club(geo=EPCI) 

tab %>% 
  select(-5,-6,-7) %>%
  cc_kable("lcrrlll") %>%
  add_header_above(c(" "= 4,"Taux"=2," ")) %>%
  credits() %>%
  footnote(number = c("F= Fédération \n","FF = Fédération Française")) %>%
  scroll_box(height = "780px") 


```

### Carte ECPI taux de clubs pour 10 000 habitants {data-height="800"}

```{r}
 
carte <- epcicarto
carte@data <- carte@data %>% select(EPCI,Population=pop)
carte <- merge(carte,tab %>% rename(Libellé=LIBGEO,
                                    `Taux de clubs`=txclub,
                                    `Taux de licences` = txlic),
               by="EPCI")

leaflet(epcicarto) %>% 
  carto(var = c("Taux de clubs", "Taux de licences","liclub") ) %>%
  contour_depbfc() 

```

### Carte ECPI licences et clubs {data-height="800"}

**Nombre de clubs et taux de pénétration sportive**

```{r}
carto2()

```


![](images/BFC_BV_s.svg) Bassins de vie {data-orientation="rows" height=30}
=======================================================================
Row {data-height="20"}
-----------------------------------------------------------------------
 Row {.tabset .tabset-fade }
-----------------------------------------------------------------------

### Comparaisons bassins de vie {vertical_layout=scroll}

```{r,echo=F}
tab <- 
  lic27bv %>%
  tab_club(geo=BV2012)

tab %>% 
  select(-5,-6,-7) %>%
  cc_kable("lcrrlll") %>%
  add_header_above(c(" "=4,"Taux"=2," ")) %>%
  credits() %>%
  footnote(number = c("F= Fédération \n","FF = Fédération Française")) %>%
  scroll_box(height = "780px") 
```

### Carte BV taux de clubs pour 10 000 habitants {data-height="800"}

```{r}
carte <- bvcarto
carte@data <- carte@data %>% select(BV2012,Population=pop)
carte <- merge(carte,tab %>% rename(Libellé=LIBGEO,
                                    `Taux de clubs`=txclub,
                                    `Taux de licences` = txlic),
               by="BV2012")

leaflet(bvcarto) %>% 
  carto(var = c("Taux de clubs", "Taux de licences","liclub") ) %>%
  contour_depbfc() 

```

### Carte BV licences et clubs {data-height="800"}

**Nombre de clubs et taux de pénétration sportive**

```{r}
carto2()
```


*En savoir* **+** {data-orientation="rows" data-icon="fa-info-circle" font-size="25px" }
=======================================================================
Row {data-height="20"}
-----------------------------------------------------------------------
Row {data-height="60"}
-----------------------------------------------------------------------

**Sources :**  



* Injep, MEDES, recensement des licences et des clubs sportifs

  + https://injep.fr/donnee/recensement-des-licences-sportives-2020/
  + https://carto-stats.injep.fr/#c=home
  


