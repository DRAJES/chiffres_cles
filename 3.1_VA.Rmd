---
title: "Vie associative"
output: 
  flexdashboard::flex_dashboard:
    vertical_layout: scroll
    social: menu
    #source_code: embed
    navbar:
      - { title: "Accueil", href: index.html, align: right, icon: fa-home }
    theme: simplex
---

```{r}

load("data/engagement/asso.RData")

RNApop <- RNAcom %>%
      left_join(.,basecom %>% 
                  select(CODGEO,LIBGEO,EPCI,BV2012),
                by=c("CODGEO_2022"="CODGEO"))

#tableau des asso
asso_tab <- function(geo){
RNApop %>% 
  filter (!is.na({{geo}}) & !is.na(objr)) %>% 
  group_by({{geo}},objr) %>% 
  summarise(asso=sum(total,na.rm = T)) %>%
  pivot_wider({{geo}} ,names_from = objr , values_from = asso) %>%
  adorn_totals("col", name = "total" ) %>%
  left_join(.,pop_basecom({{geo}}),
            by=names(select(., {{geo}})) ) 
}

#crédits et mise en forme
tableau_asso <- function(.tbl){
  .tbl %>% 
    select(1,Libellé,total,txasso,Culture,Sports,Loisirs,
           Social,Santé,`Amicales-Entraide`,Enseignement,
           Economie,Environnement,Autres,NR) %>%
    mutate_at(vars(Culture:NR),~round(.*100/total,1) ) %>%
    mutate_at(vars(Culture:Environnement),~color_tile('transparent','lightgreen')
              (digits(.,1,decimal.mark=",") ) ) %>%
    mutate(txasso=color_bar('gold')
           (digits(txasso ,2,decimal.mark=",")), 
           Autres=color_tile('transparent','lightblue')
           (digits(Autres,1,decimal.mark=",") ),
           NR=color_tile('transparent','lightgrey')
           (digits(NR,1,decimal.mark=",") ) ) 
  }
  
credits <- function(.tbl) {
  .tbl %>%
    cc_kable("crlrrrrrr") %>%
    column_spec(3, bold=T) %>%
    column_spec(4, italic=T) %>%
    footnote(general = "Répertoire National des Associations (RNA 2022); Insee, RP2019", 
             general_title = "Source : ",
             footnote_as_chunk = T) %>%
    scroll_box(height = "600px") 
}


#carto

RNAcarto <- function(geo=REG){
  RNApop %>% 
    filter (!is.na({{geo}}) & !is.na(objr)) %>% 
    group_by({{geo}},objr) %>% 
    summarise(asso=sum(total,na.rm = T)) %>%
    left_join(.,pop_basecom({{geo}}),
              by=names(select(., {{geo}})) ) %>%
    mutate(txasso=round(asso*100/pop,2)) %>%
    pivot_wider(c({{geo}},Libellé),names_from = objr , values_from = asso) %>%
    adorn_totals("col", name = "total" ) %>%
    select({{geo}},Libellé,total,Culture,Sports,Loisirs,
           Social,Santé,`Amicales-Entraide`,Enseignement,
           Economie,Environnement,Autres,NR)
}

pal <- colorBin("YlOrBr", domain =0:10 ,
                bins= c(0, 3, 3.5, 4, 4.5, 5,5.5,6,10) )
coul <- c("#4876FF", "#008B00", "#32CD32","#CD69C9", "#CD96CD", "#FFB5C5" , "#00BFFF","#FF7F50","#ADFF2F","#C0C0C0","#DCDCDC")

carte_asso <- function(){
cartasso <-   leaflet(carte) %>%  
    addPolygons(data=carte,group  = "régions",
                color = "#2F4F4F", weight = 2, smoothFactor = 2,
                fillColor = ~pal(100*carte$total/carte$pop),fillOpacity  = 0.8,
                popup = sprintf("<center> %s <br>  Nombre d'associations : <b>%i</b> <br>
                               Taux d'association :<b>%.2f</b> </center> ",  
                                carte$Libellé ,carte$total,round(100*(carte$total/carte$pop ),1) ) )   %>%
    addMinicharts(centroid(carte)[,1],centroid(carte)[,2] ,
                  #maxValues = 100,
                  type = "pie",
                  chartdata = carte@data %>% select("Culture":"NR"),
                  colorPalette = coul,
                  width = 30 *  sqrt(carte$total / sd(carte$total)),
                  opacity = 0.7) %>%
    addLegend( pal = pal ,values = 100*(carte$total/carte$pop),
               position = "bottomright", title = "taux d'associations" )
return(cartasso)
}



```

![](images/BFC_s.svg) Régions {data-orientation="rows" height=30}
=======================================================================
Row {data-height="20"}
-----------------------------------------------------------------------
Row {data-height="100"}
-----------------------------------------------------------------------

### Données générales

En novembre 2022, la Bourgogne-Franche-Comté compte **117 000** associations selon le Répertoire national des Associations.
C'est la troisième région de France en nombre d'association par habitant derrière la Corse et l'Occitanie.
Les associations sportives représentent près du quart des associations (plus grande proportion de France).

Row {.tabset .tabset-fade .tabset-pills data-height="800"}
-----------------------------------------------------------------------

### Comparaisons

**9e** région française en nombre d'associations, **3e** en taux par habitant

```{r}
tab <- RNApop %>% 
         filter (!is.na(REG) & !is.na(objr)) %>% 
         group_by(REG) %>% 
         summarise(asso=sum(total,na.rm = T)) %>%
         left_join(.,pop_basecom(REG),
                   by="REG") 


hw_grid(
  tab %>% 
    arrange(desc(asso)) %>%
    
    hchart("bar", 
           hcaes(x=reorder(Libellé,asso),y=asso, 
                 color=ifelse(REG=="27","#6a5acd","#ffd700") ),
           name="nombre d'associations",
           showInlegend=T, 
           pointWidth = 20 ) %>%
    hc_xAxis(title=list(text="Régions")) %>%
    hc_yAxis(title=list(text="Nombre d'associations")) %>%
    hc_caption(text = "<b>ATTENTION : Les associations d'Alsace-Moselle relèvent du droit local, indépendant de la loi de 1901, et ne sont pas enregistrées dans le RNA</b>"  ) %>%
    hc_add_theme(thm) %>%
    hc_exporting(enabled = TRUE, filename = "custom-file-name"),
  
  tab %>%
    adorn_totals(name = "FR", fill = "France") %>%
    mutate(txasso=round(asso*100/pop,2 )) %>%
    arrange(desc(txasso)) %>%
    hchart("bar", 
           hcaes(x=reorder(Libellé,txasso),y=txasso,
                 color=ifelse(REG=="27","#6a5acd",ifelse(REG=="FR","#ff7f50","#ffd700") ) ) ,
           name="Taux d'association pour 100 habitants", 
           showInlegend=T, 
           pointWidth = 20  )%>%
    hc_xAxis(title=list(text="Régions")) %>%
    hc_yAxis(title=list(text="Taux d'associations")) %>%
    hc_add_theme(thm) %>%
    hc_exporting(enabled = TRUE, filename = "custom-file-name"),
  rowheight = 600 ) 

```

### Tableau 

**Les domaines du sport, des loisirs et de l'économie fortement représentés**

```{r}
asso_tab(REG) %>%
  adorn_totals("row", name = "FR" ,fill = "France") %>%
  mutate(txasso=total*100/pop) %>%
  
  tableau_asso() %>%
  credits() %>%
  footnote(general = "ATTENTION : Les associations d'Alsace-Moselle relèvent du droit local, indépendant de la loi de 1901, et ne sont pas enregistrées dans le RNA"  ) 
```

### Thématiques


```{r}
tab <- RNApop %>% 
         filter (!is.na(REG) & !is.na(objr)) %>% 
         group_by(REG,objr) %>% 
         summarise(asso=sum(total,na.rm = T)) %>%
         left_join(.,pop_basecom(REG),
                   by="REG")

hw_grid(
  tab %>%
    hchart("bar", 
           hcaes(x=Libellé,y=asso,group=objr),
           stacking = "normal",
           showInlegend=T, pointWidth = 20)  %>%
    hc_caption(text = "<b>ATTENTION : Les associations d'Alsace-Moselle relèvent du droit local, indépendant de la loi de 1901, et ne sont pas enregistrées dans le RNA</b>"  ) %>%
  hc_add_theme(thm) %>%
  hc_exporting(enabled = TRUE, filename = "custom-file-name"),

  tab %>%
    mutate(txasso=round(asso*100/sum(asso),2)) %>%
    hchart("bar", 
           hcaes(x=Libellé,y=txasso,group=objr),
           stacking = "percent",
           showInlegend=T, pointWidth = 20)  %>%
    hc_add_theme(thm) %>%
    hc_exporting(enabled = TRUE, filename = "custom-file-name"),

rowheight = 600)



```

```{r}
### Nombre de femmes

```



```{r, include=FALSE}
hchart(RNA %>%
         filter(position=="A") %>% 
         filter(observation!="DISSOUTE")%>%
         filter (!is.na(REG) & !is.na(objr)) %>%
         group_by(dir_civilite) %>%
         count(name="nb associations") ,
         "spline",hcaes(x=dir_civilite, y=`nb associations` ) ) %>%
  hc_caption(text = "<b>ATTENTION : Les associations d'Alsace-Moselle relèvent du droit local, indépendant de la loi de 1901, et ne sont pas enregistrées dans le RNA</b>"  )

```


### Evolution
Créations d'associations par année
```{r}
hw_grid(
  RNA %>% 
    filter (!is.na(REG) & !is.na(objr)) %>% 
    filter(année > 2010 ) %>%
    group_by(année) %>% 
    count(name="nb associations") %>%
    hchart("spline",
           hcaes(x=année,y=`nb associations`),
           marker = FALSE) %>%
    hc_caption(text = "<b>ATTENTION : Les associations d'Alsace-Moselle relèvent du droit local, indépendant de la loi de 1901, et ne sont pas enregistrées dans le RNA</b>"  ) %>%
    hc_exporting(enabled = TRUE, filename = "custom-file-name"),
  
  RNA %>% 
    filter (!is.na(REG) & !is.na(objr)) %>% 
    filter(année > 2010 ) %>%
    group_by(REG, année) %>% 
    count(name="nb associations") %>%
    left_join(.,pop_basecom(REG),
              by="REG") %>%
  hchart("areaspline",
         hcaes(x=année,y=`nb associations`,group=Libellé),
         stacking = "normal", 
         marker = FALSE) %>%
    hc_exporting(enabled = TRUE, filename = "custom-file-name"),
  rowheight = 600 ) 
#htmltools::browsable()
```




### Carte 
Hors Alsace-Moselle
```{r}
carte <- merge(regwgs,RNAcarto(geo=REG),by="REG")

carte_asso() %>% contour_bfc()
```




![](images/BFC_dep_s.svg) Départements {data-orientation="rows" height=30}
=======================================================================
Row {data-height="20"}
-----------------------------------------------------------------------
Row {.tabset .tabset-fade .tabset-pills data-height="100"}
-----------------------------------------------------------------------


### Données générales

Jura, Nièvre et Haute-Saône : les départements les moins peuplés sont ceux où les associations sont les plus fréquentes

Row {.tabset .tabset-fade .tabset-pills data-height="800"}
-----------------------------------------------------------------------

### Comparaisons

```{r}
tab <- RNApop %>% 
         filter (!is.na(DEP) & !is.na(objr)) %>% 
         group_by(DEP) %>% 
         summarise(asso=sum(total,na.rm = T)) %>%
         left_join(.,pop_basecom(DEP),
                   by="DEP") 

hw_grid(
  tab %>%
    arrange(desc(asso)) %>%
    hchart("bar", 
           hcaes(x=reorder(Libellé,asso),y=asso, 
                 color=ifelse(DEP %in% depbfc,"#6a5acd","#ffd700") ),
           name="Nombre d'associations",
          showInLegend=T, pointWidth = 1 ) %>%
   hc_add_series(tab %>% 
                  filter (DEP %in% depbfc) %>%
                  arrange(desc(asso)),  
          "bar",  hcaes(x=reorder(Libellé,asso),y=asso),
                  color="#6a5acd",
                  name="Nombre d'associations",
                  showInLegend=F, pointWidth = 3 ) %>%
    hc_legend(title=list(text=" France/BFC (Clic pour zoomer) " )) %>%
    hc_xAxis(title=list(text="Départements")) %>%
    hc_yAxis(title=list(text="Nombre d'associations")) %>%
    hc_caption(text = "<b>ATTENTION : Les associations d'Alsace-Moselle relèvent du droit local, indépendant de la loi de 1901, et ne sont pas enregistrées dans le RNA</b>"  ) %>%
   hc_add_theme(thm) %>%
   hc_exporting(enabled = TRUE, filename = "custom-file-name"),
  
  tab %>%
    adorn_totals(name = "FR", fill = "France") %>%
    bind_rows( RNApop %>% 
                 filter (REG=="27" & !is.na(objr)) %>% 
                      group_by(REG) %>%  
                      summarise(asso=sum(total,na.rm = T)) %>%
                      left_join(.,pop_basecom(REG),
                                by="REG") %>%
                      rename(DEP=REG) %>% 
                      mutate(Libellé="Bourgogne-Franche-Comté" )  ) %>%
         mutate(txasso=round(asso*100/pop,2 )) %>%
         mutate(Libellé=ifelse(DEP=="FR","France",Libellé) ) %>%
         arrange(desc(txasso)) %>%
    hchart("bar", 
           hcaes(x=reorder(Libellé,txasso),y=txasso,
                 color=ifelse(DEP %in% depbfc,"#6a5acd",
                     ifelse(DEP=="FR","#ff7f50","#ffd700"))),
         name="Taux d'association pour 100 habitants", 
         showInLegend=T, pointWidth = 1  ) %>%
 
  hc_add_series(tab %>%
                  filter(DEP %in% depbfc) %>%
                  adorn_totals(name = "BFC", fill = "Bourgogne-Franche-Comté" )%>%
                  mutate(txasso=round(asso*100/pop,2 )) %>%
                  arrange(desc(txasso)),  
          "bar",  hcaes(x=reorder(Libellé,txasso),y=txasso,
                        color=ifelse(DEP %in% depbfc,"#6a5acd",
                              ifelse(DEP=="BFC","#ff7f50","#ffd700"))),
                  name="Taux d'association pour 100 habitants", 
                  showInLegend=F, pointWidth = 3 ) %>%
   
    hc_legend(title=list(text=" France/BFC (Clic pour zoomer) " )) %>%
    hc_xAxis(title=list(text="Départements")) %>%
    hc_yAxis(title=list(text="Taux d'associations")) %>%
    hc_add_theme(thm) %>%
    hc_exporting(enabled = TRUE, filename = "custom-file-name"),
rowheight = 600)


```

### Tableau 

Plus de 20 000 associations dans le Doubs, la Côte d'Or et le Saône et Loire

```{r}
asso_tab(DEP) %>%
  filter(DEP %in% depbfc) %>%
  adorn_totals("row", name = "BFC" , fill = "Bourgogne-Franche-Comté") %>%
  mutate(txasso=total*100/pop) %>%
  tableau_asso() %>%
  credits()
  
```

### Thématiques
de nombreuses associations sportives

```{r}
tab <- RNApop %>% 
         filter (!is.na(REG) & !is.na(objr)) %>% 
         group_by(REG,DEP,objr) %>% 
         filter (DEP %in% depbfc) %>% 
         summarise(asso=sum(total,na.rm = T)) %>%
         left_join(.,pop_basecom(DEP),
                   by="DEP") %>%
        #adorn_totals(name = "FR")%>%
         mutate(txasso=round(asso*100/pop,2))


hw_grid(
  tab %>%
    hchart("bar", 
           hcaes(x=Libellé,y=asso,group=objr),
           stacking = "normal",
           showInlegend=T, pointWidth = 20)  %>%
    hc_add_theme(thm) %>%
    hc_exporting(enabled = TRUE, filename = "custom-file-name"),
  tab %>%
    hchart("bar", 
           hcaes(x=Libellé,y=txasso,group=objr),
           stacking = "percent",
           showInlegend=T, pointWidth = 20)  %>%
    hc_add_theme(thm) %>%
    hc_exporting(enabled = TRUE, filename = "custom-file-name"),

rowheight = 600)

```

### Evolution
Créations d'associations par année

```{r}
#```{r, figures-side, fig.show="hold", out.width="50%"}
tab <- RNA %>%
         filter (!is.na(DEP) & !is.na(objr)) %>% 
         filter(année > 2010) %>%
         filter(DEP %in% depbfc) %>%
         group_by(DEP, année) %>% 
         count(name="nb associations") %>%
         left_join(.,appartenance %>%
                     filter(NIVGEO=="DEP") %>%
                     select(CODGEO,LIBGEO),
                   by=c("DEP"="CODGEO"))

hw_grid(
  tab %>%
    hchart("spline",
           hcaes(x=année,y=`nb associations`,group=LIBGEO),
           # stacking = "normal", 
           marker = FALSE ) %>%
    hc_exporting(enabled = TRUE, filename = "custom-file-name"),
  tab %>%
    hchart("areaspline",
           hcaes(x=année,y=`nb associations`,group=LIBGEO),
           stacking = "normal", 
           marker = FALSE ) %>%
    hc_exporting(enabled = TRUE, filename = "custom-file-name"),

 rowheight = 600) 
#htmltools::browsable()

```

### Carte 
Hors Alsace-Moselle
```{r}
carte <- merge(depwgs,RNAcarto(geo=DEP),by="DEP")

carte_asso() %>% contour_bfc()
```


![](images/BFC_EPCI_s.svg) EPCI {data-orientation="rows" height=30}
=======================================================================
Row {data-height="20"}
-----------------------------------------------------------------------
Row {.tabset .tabset-fade .tabset-pills data-height="800"}
-----------------------------------------------------------------------


### Tableau des associations 
```{r}
tab <- asso_tab(EPCI) %>% 
  filter(EPCI %in% basecom$EPCI[basecom$REG=="27"]) %>%
  arrange(desc(total)) %>%
  mutate(txasso=total*100/pop) %>%
  tableau_asso() 

tab %>%
  credits()
```

### Tableau filtré
```{r}
tab <- tab %>% 
  filter(!EPCI %in% c('BFC','METRO')) %>% 
  rename(LibEPCI=Libellé)

sd <- tab_filtre(geo=EPCI)

filter_checkbox("dep","Département",sd,group=~filtre_DEP, 
                inline=TRUE, allLevels = FALSE)

sd %>% datafiltre()
```

### Carte EPCI

```{r}
carte <- merge(epcicarto,RNAcarto(geo=EPCI),by="CODE_EPCI")

carte_asso() %>% contour_depbfc()

```

![](images/BFC_BV_s.svg) Bassins de vie {data-orientation="rows" height=30}
=======================================================================
Row {data-height="20"}
-----------------------------------------------------------------------
Row {.tabset .tabset-fade .tabset-pills data-height="800"}
-----------------------------------------------------------------------


### Tableau des associations 
```{r}
tab <- asso_tab(BV2012) %>%
  filter(BV2012 %in% basecom$BV2012[basecom$REG=="27"]) %>%
  arrange(desc(total)) %>%
  mutate(txasso=total*100/pop) %>%
  tableau_asso()

tab %>%
  credits()
```

### Tableau filtré
```{r}
tab <- tab %>% 
  filter(!BV2012 %in% c('BFC','METRO')) %>%
  rename(LibBV=Libellé)


sd <- tab_filtre(geo=BV2012)

filter_checkbox("dep","Département",sd,group=~filtre_DEP, 
                inline=TRUE, allLevels = FALSE)

sd %>% datafiltre()
```

### carte BV

```{r}
carte <- merge(bvcarto,RNAcarto(geo=BV2012),by="BV2012")

carte_asso() %>% contour_depbfc()
```


*En savoir* **+** {data-orientation="rows" data-icon="fa-info-circle" font-size="25px" }
=======================================================================
Row {data-height="20"}
-----------------------------------------------------------------------
Row {data-height="60"}
-----------------------------------------------------------------------

**Sources :**  

**ATTENTION : Les associations d'Alsace-Moselle relèvent du droit local, indépendant de la loi de 1901, et ne sont pas enregistrées dans le RNA.**


* Répertoire National des Associations (RNA)  

  + https://www.data.gouv.fr/fr/datasets/repertoire-national-des-associations/  
  
* Recherche et solidarités  

  + https://recherches-solidarites.org/dans-les-regions-liste/#Bourgogne


