---
title: "Structure"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    social: menu
    #source_code: embed
    navbar:
      - { title: "Accueil", href: index.html, align: right, icon: fa-home }
    theme: simplex
---
 
 
```{r} 
#défintion des variables des tableaux
demo <- function(.tbl,geo) {.tbl %>%
     select({{geo}},Nom,Population,
            `15-29 ans`,`Taux<br>15/29`, `Taux femmes<br>15/29`,
         `65 ans et +`,`Taux<br>>65 ans`,`Taux femmes<br>>65 ans`, 
         ind_jeun) %>%
    rename("indice jeunesse <sup>1</sup>"=ind_jeun) 
}


#définition des sources et headers
credits <- function(.tbl){
  .tbl %>% 
    cc_kable(aligne = "clrrlcrlcc") %>%
    # column_spec(5,width = "3cm") %>% 
    #  column_spec(8,width = "3cm") %>%
    add_header_above(c(" " = 3, 
                       "Jeunes" =3, 
                       "Population âgée" = 3,
                       " ")) %>%
    footnote(general = " Insee RP2019", 
           general_title = "Source : ",
           number = "Nombre de -20 ans / nombre de + 60 ans",
           footnote_as_chunk = T)   }


#Structure
hstructure <- function(.tbl,geo) {
  .tbl %>%
    hchart( "bar",  
            hcaes(x = .data[[geo]], y = part, group = âge) ,
            stacking = "percent" , 
            reverse = T, 
            showInLegend = T,  
            pointWidth =20) %>%
    hc_xAxis(title = list(text = "")) %>%
    hc_add_theme(thm) %>%
    hc_exporting(enabled = TRUE, filename = "custom-file-name")
}

#définition des ronds proportionnels et choroplèthe
pal <- colorBin("Purples", domain =0:200 ,
                bins=c(0, 50, 75, 100 , Inf), 
                reverse = T)

pal2 <- colorBin("YlOrBr", domain =0:100 ,
                 bins= c(0, 12.5, 15, 17.5, 20, 100) )

var <- c("pop","ind_jeun","p1529") #définition des variables de la carte

carto <- function(.map) {
  .map %>%
  addPolygons(data = carte,
              fillColor = ~pal(ind_jeun), fillOpacity = 0.7,
              color = "#2F4F4F", weight = 2,opacity = 0.6, 
              smoothFactor = 2 ) %>%
  addLegend(pal = pal, values =  regwgs$ind_jeun, opacity = 0.7, 
            title = "indice de jeunesse", position = "bottomright") %>%
  
  addCircles(centroid(carte)[,1],centroid(carte)[,2],
             radius = ~100*p1529^(1/2), 
             color = "#4169E1", weight=4,
             fillColor = ~pal2(100*p1529/pop), fillOpacity = 0.7,
             highlight = highlightOptions (
                             color = "#00FFFF", weight = 5,
                             fillOpacity =  0.4 ),
             popup = popupTable(carte@data %>%
                                  select(-var),
                                feature.id=F,row.numbers = F) ) %>%
  addLegend(pal = pal2,values = regwgs$prop1529,
            opacity = 0.7,
            title = "taux de 15/29 ans",
            labFormat = labelFormat(suffix =  " %"),
            position = "bottomright")
}

```

![](images/BFC_s.svg) Régions {data-orientation="rows" height=30}
=======================================================================
Row {data-height="20"}
-----------------------------------------------------------------------

Row  {data-height=100}
-----------------------------------------------------------------------
### Données générales

La population de Bourgogne-Franche-Comté est plutôt âgée. L'indice de jeunesse s'établit à 
**`r  prettyNum(round(region$ind_jeun[3],1),decimal.mark=",")`**, nettement en dessous de la valeur métropolitaine.

Les **`r  prettyNum(round(region$p1529[3]/1000,0)*1000,big.mark=" ")`** jeunes sont sous-représentés et les + de 65 ans sont surreprésentés.

Row {.tabset .tabset-fade}
-----------------------------------------------------------------------
  
### Comparaisons régionales
  
```{r,echo=F}
tab <- region_tab %>%
  demo(geo=Région)

tab %>%  
  credits()

```   

### Structure régionale
```{r}
region %>%
  dplyr::select(REG,LIBGEO,p20,p60,pop) %>%
  transmute(REG,LIBGEO,
            `1_21 à 59 ans`=round(100*(pop-p20-p60)/pop,2),
            `2_Moins de 20 ans`=round(100*p20/pop,2),
            `0_Plus de 60 ans`=round(100*p60/pop,2) ) %>%
  pivot_longer(-c('REG','LIBGEO'),'âge') %>% 
  rename(Région=LIBGEO,part=value) %>%
  arrange(REG,Région,âge)  %>%
hstructure("Région")
```

### Carte régionale
```{r}
carte <- regwgs
carte@data <- carte@data %>% select(Région=REG,var)
carte <- merge(carte,tab,by="Région")


leaflet(carte) %>%  
  carto() %>%
  contour_bfc() 
   
```


![](images/BFC_dep_s.svg) Départements {data-orientation="rows" height=30}
=======================================================================
Row {data-height="20"}
-----------------------------------------------------------------------

Row  {data-height=100}
-----------------------------------------------------------------------
### Données générales

La Côte d'Or est de département où les 15/29 ans sont les plus nombreux tandis que le Doubs est celui ou les plus de 65 ans sont les moins nombreux. Dans la Nièvre, le déséquilibre est très marqué. Les plus de 65 ans sont deux fois plus nombreux que les 15/29 ans.


  Row {.tabset .tabset-fade}
-----------------------------------------------------------------------

### Comparaisons départementales 

```{r,echo=F}
tab <- dep27_tab %>%  
    demo(geo=Département) %>% 
  ungroup() %>%
  select(-Région)

tab %>%  
  credits()
```

### Structure départementale
```{r}
departement %>% 
  filter(DEP %in% depbfc) %>%
  dplyr::select(DEP,LIBGEO,p20,p60,pop) %>%
  transmute(DEP,LIBGEO,
            `1_21 à 59 ans`=round(100*(pop-p20-p60)/pop,2),
            `2_Moins de 20 ans`=round(100*p20/pop,2),
            `0_Plus de 60 ans`=round(100*p60/pop,2) ) %>%
  pivot_longer(-c('DEP','LIBGEO'),'âge') %>% 
  rename(Département=LIBGEO,part=value) %>%
  arrange(DEP,Département,âge) %>%
  hstructure("Département")


```


### Carte départementale
```{r}
carte <- depwgs
carte@data <- carte@data %>% select(Département=DEP,var)
carte <- merge(carte,tab,by="Département")


leaflet(carte) %>%  
  carto() %>%
  contour_bfc() 
```

![](images/BFC_EPCI_s.svg) EPCI {data-orientation="rows" height=30}
=======================================================================
Row {data-height="20"}
-----------------------------------------------------------------------

  Row {.tabset .tabset-fade}
-----------------------------------------------------------------------

### Comparaisons établissements publics de coopération intercommunale
  
```{r,echo=F}
tab <- epci27_tab %>%
  demo(geo=EPCI)

tab %>%  
  credits()
```



### Carte ECPI
```{r}
carte <- epcicarto
carte@data <- carte@data %>% select(EPCI,var)
carte <- merge(carte,tab,by="EPCI")


leaflet(carte) %>%  
  carto() %>%
  contour_depbfc() 
```
  
  

![](images/BFC_BV_s.svg) Bassins de vie {data-orientation="rows" height=30}
=======================================================================
Row {data-height="20"}
-----------------------------------------------------------------------
  
  Row {.tabset .tabset-fade}
-----------------------------------------------------------------------
  
### Comparaisons bassins de vie
```{r,echo=F}
tab <- bv27_tab %>%
  demo(geo=BV2012)

tab %>%  
  credits()
```  
  
  
  
### Carte BV
```{r}
carte <- bvcarto
carte@data <- carte@data %>% select(BV2012,var)
carte <- merge(carte,tab,by="BV2012")


leaflet(carte) %>%  
  carto() %>%
  contour_depbfc() 
```


*En savoir* **+** {data-orientation="rows" data-icon="fa-info-circle" font-size="25px" }
=======================================================================
Row {data-height="20"}
-----------------------------------------------------------------------
Row {data-height="60"}
-----------------------------------------------------------------------

**Sources :**  

* Insee, Recensement de la population 2018

  + https://www.insee.fr/fr/information/5369871
  + https://www.insee.fr/fr/statistiques/5397467?geo=FE-1


